# syntax=docker/dockerfile:1
FROM rust:latest

WORKDIR /root

COPY configs/.config/ptdb ./.config/ptdb

WORKDIR /root/code

# COPY tests/db-output tests/db-output
COPY configs/etc/ptdb/config.toml /etc/ptdb/config.toml
COPY configs/etc/ptdb/make-db.sql /etc/ptdb/make-db.sql
COPY configs/etc/ptdb/templates.toml /etc/ptdb/templates.toml
# COPY install.sh install.sh
# COPY workspaces workspaces
# COPY install.sh install.sh

ENV WORDLIST=dir-list-common.txt

# install rust nightly
RUN rustup toolchain install nightly
RUN rustup default nightly

# set up proper symlinks
# RUN bash -c 'ln -s ~/.config/ptdb/engagements/SAMPLE-ENGAGEMENT.toml ~/.config/ptdb/engagement.toml'
# RUN bash -c 'ln -s ~/.config/ptdb/db-servers/default.toml ~/.config/ptdb/db-servers/local.toml'

# RUN ln -s ~/.config/ptdb/engagements/SAMPLE-ENGAGEMENT.toml ~/.config/ptdb/engagement.toml
# RUN ln -s ~/.config/ptdb/db-servers/default.toml ~/.config/ptdb/db-servers/local.toml
# RUN ls ~/.config/ptdb/db-servers/local.toml
# RUN ls ~/.config/ptdb/engagement.toml
# RUN cargo build

# install test depedencies
RUN apt update
RUN apt install nmap iputils-ping curl iproute2 python3 python-is-python3 gobuster postgresql -y

# get wordlists for directory brute force
RUN curl -o $WORDLIST 'https://raw.githubusercontent.com/v0re/dirb/master/wordlists/common.txt'

CMD ["bash", "tests/test.sh"]
