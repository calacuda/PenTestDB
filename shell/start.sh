#!/bin/sh

# add "echo -n "" > $log_io" after any fetch program you use

start() {
  #make log file names
  if [[ -d "/tmp/ptdb/logs" ]]; then
    n=$(($(/usr/bin/ls /tmp/ptdb/logs/ | grep -v ".tmp" | sort -n | tail -n 1) + 1))
  else
    n=1
  fi
  log_dir="/tmp/ptdb/logs/$n"
  mkdir -p $log_dir
  log_f="$log_dir/full"
  log_io="$log_dir/stdio"
  log="1" # is used to pause logging temporarily. (set to anythin else and logging is paused, untill set back to 1)

  #exports
  export log_f
  export log_io
  export log

  #main
  script -qfa $log_f -B $log_io

  #cleanup
  rm -r $log_dir
  exit
}

function preexec {
  #if [[ $log == "1" ]]; then
  echo "$1" > $log_io
  echo "$2" >> $log_io
  echo "$3" >> $log_io
  #fi
}

function precmd {
  #if [[ $log == "1" && $? == "0" ]]; then
  # add the arguemnt 'client' to the end of the next command to run in server client mode.
  cat $log_io | ansi2txt | ptdb 
  #fi
}

if [[ x"${log}" == "x" ]]; then
  start
fi
