#!/bin/sh

# add "echo -n "" > $log_io" after any fetch program you use

start() {
  #make log file names
  if [[ -d "/tmp/ptdb/logs" ]]; then
    n=$(($(/usr/bin/ls /tmp/ptdb/logs/ | grep -v ".tmp" | sort -n | tail -n 1) + 1))
  else
    n=1
  fi
  log_dir="/tmp/ptdb/logs/$n"
  mkdir -p $log_dir
  log_f="$log_dir/full"
  log_io="$log_dir/stdio"
  log=$n
  logging=true
  

  #exports
  export log_f
  export log_io
  export log
  export logging

  #main
  script -qfa $log_f -B $log_io

  #cleanup
  rm -r $log_dir
  exit
}

function preexec {
  echo "$1" > $log_io
  echo "$2" >> $log_io
  echo "$3" >> $log_io
}

function precmd {
  # add the arguemnt 'client' to the end of the next command to run in server client mode.
  cat $log_io | ptdb parse > /dev/null
  echo -n "" > $log_io
}

# this is not ideal as it will cause 
# if [[ x"${log}" == "x" ]]; then
if [ "$logging" != true ]; then
  start 
else;
  logging=false
  export logging
fi